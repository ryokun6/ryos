# Chat Rooms API (REST)

Real-time chat rooms API powered by Redis (Upstash) with optional Pusher broadcasts. The API is RESTful and no longer uses the legacy `?action=` query parameter.

## Authentication

Authenticated endpoints require:

```
Authorization: Bearer {token}
X-Username: {username}
```

Tokens are issued by `/api/auth/register` and `/api/auth/login`.

## Endpoint Summary

### Auth

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/auth/register` | Create user + issue token |
| POST | `/api/auth/login` | Login with password |
| POST | `/api/auth/logout` | Logout current session |
| POST | `/api/auth/logout-all` | Logout all sessions |
| POST | `/api/auth/token/verify` | Verify token |
| POST | `/api/auth/token/refresh` | Refresh token |
| GET | `/api/auth/password/check` | Check if password set |
| POST | `/api/auth/password/set` | Set password |
| GET | `/api/auth/tokens` | List active tokens |

### Rooms

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/rooms` | List rooms (public + private membership) | No |
| POST | `/api/rooms` | Create room | Yes |
| GET | `/api/rooms/{id}` | Get room by ID | No |
| DELETE | `/api/rooms/{id}` | Delete room | Yes |
| POST | `/api/rooms/{id}/join` | Join room | No |
| POST | `/api/rooms/{id}/leave` | Leave room | No |
| GET | `/api/rooms/{id}/users` | List active users | No |

### Messages

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/rooms/{id}/messages` | List messages | No |
| POST | `/api/rooms/{id}/messages` | Send message | Yes |
| DELETE | `/api/rooms/{id}/messages/{messageId}` | Delete message (admin) | Yes (admin) |
| GET | `/api/messages/bulk?roomIds=...` | Bulk messages | No |

### Presence + Users

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/presence/switch` | Switch rooms (presence tracking) |
| GET | `/api/users?search=...` | Search users |

### AI Reply

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/ai/ryo-reply` | Generate Ryo reply in a room (auth required) |

## Examples

### Create user

```bash
POST /api/auth/register
Body: { "username": "alice", "password": "testpassword123" }

// Response
{ "user": { "username": "alice" }, "token": "..." }
```

### Create room

```bash
POST /api/rooms
Headers: { Authorization: "Bearer ...", "X-Username": "alice" }
Body: { "type": "private", "members": ["alice", "bob"] }
```

### List rooms

```bash
GET /api/rooms?username=alice
```

### Send message

```bash
POST /api/rooms/{roomId}/messages
Headers: { Authorization: "Bearer ...", "X-Username": "alice" }
Body: { "content": "Hello world" }
```

### Delete message (admin)

```bash
DELETE /api/rooms/{roomId}/messages/{messageId}
Headers: { Authorization: "Bearer ...", "X-Username": "ryo" }
```

### Presence switch

```bash
POST /api/presence/switch
Body: { "previousRoomId": "oldId", "nextRoomId": "newId", "username": "alice" }
```

### AI reply

```bash
POST /api/ai/ryo-reply
Headers: { Authorization: "Bearer ...", "X-Username": "alice" }
Body: { "roomId": "abc123", "prompt": "what's up?" }
```

## Rate Limits (high level)

- **Messages**: burst protection in public rooms (short + long window, min interval)
- **Ryo reply**: 5/min per user

## Legacy Note

The legacy `/api/chat-rooms?action=...` endpoint has been removed. Use the REST endpoints listed above.
