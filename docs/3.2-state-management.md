# State Management

ryOS uses Zustand for state management with 21 stores following consistent patterns.

## Store Inventory

| Store | Purpose | Persistence Key |
|-------|---------|-----------------|
| `useAppStore` | Window/instance management, boot state | `ryos:app-store` |
| `useFilesStore` | Virtual filesystem metadata | `ryos:files` |
| `useChatsStore` | Chat rooms, messages, auth | `ryos:chats` |
| `useIpodStore` | Music library, playback | `ryos:ipod` |
| `useThemeStore` | OS theme selection | Manual localStorage |
| `useDisplaySettingsStore` | Wallpaper, shaders | `ryos:display-settings` |
| `useDockStore` | Dock pinned items | `dock-storage` |
| `useAudioSettingsStore` | Volume, TTS settings | `ryos:audio-settings` |
| `useVideoStore` | Video library, playback | `ryos:videos` |
| `useTerminalStore` | Command history, vim state | `ryos:terminal` |
| `useSynthStore` | Synthesizer presets | `ryos:synth` |

### Store Architecture

```mermaid
graph TD
    subgraph Core["Core System"]
        AppStore[useAppStore<br/>Windows & Boot]
        ThemeStore[useThemeStore<br/>Theme]
        DisplayStore[useDisplaySettingsStore<br/>Wallpaper & Shaders]
        AudioStore[useAudioSettingsStore<br/>Volume & TTS]
        DockStore[useDockStore<br/>Pinned Items]
    end

    subgraph Media["Media Apps"]
        IpodStore[useIpodStore<br/>Music Library]
        VideoStore[useVideoStore<br/>Video Library]
        SynthStore[useSynthStore<br/>Synth Presets]
    end

    subgraph Social["Communication"]
        ChatsStore[useChatsStore<br/>Chat & Auth]
    end

    subgraph Productivity["Productivity"]
        FilesStore[useFilesStore<br/>Virtual FS]
        TerminalStore[useTerminalStore<br/>CLI State]
    end

    AppStore --> |manages| Media
    AppStore --> |manages| Social
    AppStore --> |manages| Productivity
    ChatsStore -.-> |auth| IpodStore
```

## Store Pattern

```typescript
import { create } from "zustand";
import { persist } from "zustand/middleware";

interface StoreState {
  someValue: string;
  setSomeValue: (v: string) => void;
}

export const useMyStore = create<StoreState>()(
  persist(
    (set) => ({
      someValue: "default",
      setSomeValue: (v) => set({ someValue: v }),
    }),
    {
      name: "ryos:my-store",
      version: 1,
      partialize: (state) => ({
        someValue: state.someValue,
      }),
    }
  )
);
```

## Cross-Store Communication

- `useKaraokeStore` → reads from `useIpodStore` (shared music library)
- `useTextEditStore` → reads from `useAppStore` (foreground instance)
- `useIpodStore` → reads from `useChatsStore` (auth credentials)

```mermaid
flowchart LR
    subgraph Components["React Components"]
        C1[IpodApp]
        C2[KaraokeApp]
        C3[TextEditApp]
    end

    subgraph Stores["Zustand Stores"]
        S1[useIpodStore]
        S2[useKaraokeStore]
        S3[useTextEditStore]
        S4[useChatsStore]
        S5[useAppStore]
    end

    subgraph Persist["localStorage"]
        P1[(ryos:ipod)]
        P2[(ryos:chats)]
        P3[(ryos:app-store)]
    end

    C1 <--> S1
    C2 <--> S2
    C3 <--> S3

    S2 -.-> |music library| S1
    S3 -.-> |foreground instance| S5
    S1 -.-> |auth credentials| S4

    S1 --> P1
    S4 --> P2
    S5 --> P3
```
