# Push API

ryOS provides authenticated endpoints for managing device push tokens and sending APNs test notifications.

These endpoints are designed for the iOS Tauri wrapper integration and use Redis for token persistence.

## Authentication

All push endpoints require:

| Header | Description |
|--------|-------------|
| `Authorization` | Bearer token: `Bearer <token>` |
| `X-Username` | Username for the bearer token |

`Authorization` bearer scheme matching is case-insensitive (`Bearer`, `bearer`, etc.).

All push endpoints are CORS-restricted. Requests (including `OPTIONS` preflight)
from disallowed origins are rejected with `403 Unauthorized`.
Allowed preflight responses echo normalized requested CORS headers when provided
(trimmed and case-insensitively deduplicated).
Push endpoint responses include `Vary` headers for origin-sensitive caching.

Origin policy summary:

- **Production**: `https://os.ryo.lu`
- **Preview**: project-scoped Vercel preview hosts (`ryos-*`, `ryo-lu-*`, `os-ryo-*`)
- **Development**: localhost/loopback on ports `80`, `443`, `3000`, `5173`
- **Any env**: trusted tailscale suffix `*.tailb4fa61.ts.net`

## Data Model

Redis keys used by the push API:

- `push:user:{username}:tokens` â€” Set of device tokens for a user
- `push:token:{token}` â€” Token metadata (`username`, `platform`, `updatedAt`)

Token metadata is stored with a 1-year TTL and ownership-safe cleanup behavior.

---

## Register Token

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/register` |

### Request Body

```json
{
  "token": "abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789",
  "platform": "ios"
}
```

Validation rules:

- body must be a JSON object
- `token` is required, must be a string, and must match push token format
- blank `token` values are rejected
- `platform` (if provided) must be a string and normalize to `ios` or `android`

### Fields

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `token` | string | Yes | 20-512 chars, alphanumeric plus `: _ - .` |
| `platform` | `"ios" \| "android"` | No | Defaults to `"ios"`; case-insensitive input accepted |

### Behavior

- Body must be a JSON object.
- Associates the token with the authenticated user.
- If token metadata already belongs to a different user, the token is transferred and removed from the previous userâ€™s token set.

### Success Response (200)

```json
{
  "success": true,
  "token": "abcdef...",
  "platform": "ios"
}
```

---

## Unregister Token(s)

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/unregister` |

### Request Body

To remove one token:

```json
{
  "token": "abcdef..."
}
```

To remove all current user tokens:

```json
{}
```

### Behavior

- Body must be a JSON object.
- Single-token unregister validates token format.
- Metadata deletion only occurs when metadata ownership matches the authenticated user.
- Bulk unregister resolves ownership first, deletes only metadata keys owned by the same user, then deletes the user token set.
- Bulk unregister also removes invalid token-string entries found in the user token set.

### Success Response (200)

```json
{
  "success": true,
  "removed": 1,
  "metadataRemoved": 1,
  "invalidStoredTokensRemoved": 0,
  "skippedNonStringTokenCount": 0,
  "pushMetadataLookupConcurrency": 0,
  "removedUserTokenSet": 0
}
```

For bulk mode:

```json
{
  "success": true,
  "removed": 3,
  "metadataRemoved": 3,
  "invalidStoredTokensRemoved": 1,
  "skippedNonStringTokenCount": 0,
  "pushMetadataLookupConcurrency": 8,
  "removedUserTokenSet": 1
}
```

`pushMetadataLookupConcurrency` is `0` for single-token/no-token paths that do not perform ownership fanout lookups, and reports the effective bounded lookup concurrency for bulk ownership checks.
Cleanup counters (`removed`, `metadataRemoved`, `invalidStoredTokensRemoved`) use Redis command result counts when available, with fallback to deduplicated attempted-token counts when result formats are unavailable.
`removedUserTokenSet` indicates whether the per-user token set key was deleted in bulk mode (`1` for deleted, `0` otherwise).

---

## Send Test Push

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/test` |

### Request Body

```json
{
  "title": "ryOS test notification",
  "body": "Push notifications are working ðŸŽ‰",
  "token": "optional-specific-token",
  "badge": 1,
  "sound": "default",
  "data": {
    "source": "manual-test"
  }
}
```

Validation rules:

- body must be a JSON object
- `title` max length: 120 chars (default provided when empty/missing)
- `body` max length: 512 chars (default provided when empty/missing)
- `title`, `body`, `sound`, and `token` (if provided) must be strings
- `badge` must be integer `0..9999`
- `sound` max length: 64 chars
- `token` (if provided) must match push token format
- blank `token` values are rejected
- `data` must be a plain JSON object and serialized size <= 2048 bytes

### Behavior

- Sends APNs alert notifications to:
  - all registered user tokens, or
  - one specific token if `token` is provided.
- Targeted mode (`token` provided) performs a direct membership check for that token instead of scanning the full stored token set.
- Multi-token sends are executed with bounded concurrency (default 4, configurable via `APNS_SEND_CONCURRENCY`) to avoid APNs burst overload.
- When broadcasting to all user tokens (no `token` in request), invalid token-string entries discovered in the stored token set are cleaned up before sending.
- Before sending, endpoint verifies token ownership via metadata:
  - all tokens when broadcasting to all user tokens
  - just the requested token when `token` is explicitly provided
- Non-owned/stale token entries encountered during ownership checks are removed from the user token set.
- In targeted mode, if initial membership check fails before ownership lookup, endpoint returns `403` with `staleOwnershipTokensRemoved: 0` and `pushMetadataLookupConcurrency: 0`.
- In targeted mode, if the requested token fails ownership checks after cleanup, endpoint returns `403` with ownership and cleanup diagnostics (`staleOwnershipTokensRemoved`, `pushMetadataLookupConcurrency`, `invalidStoredTokensRemoved`, `skippedNonStringTokenCount`).
- If ownership checks leave no eligible tokens, endpoint returns `400` with ownership and cleanup diagnostics (`staleOwnershipTokensRemoved`, `pushMetadataLookupConcurrency`, `invalidStoredTokensRemoved`, `skippedNonStringTokenCount`).
- If APNs returns stale-token reasons (`BadDeviceToken`, `Unregistered`, `DeviceTokenNotForTopic`), stale tokens are removed from Redis.
- In broadcast mode, if no valid user tokens remain after cleanup, endpoint returns `400` with cleanup diagnostics (`invalidStoredTokensRemoved`, `skippedNonStringTokenCount`).

### Success Response (200)

```json
{
  "successCount": 1,
  "failureCount": 0,
  "failureReasons": {},
  "apnsSendConcurrency": 4,
  "pushMetadataLookupConcurrency": 8,
  "invalidStoredTokensRemoved": 0,
  "skippedNonStringTokenCount": 0,
  "staleTokensRemoved": 0,
  "staleOwnershipTokensRemoved": 0,
  "results": [
    {
      "ok": true,
      "status": 200,
      "token": "abcdef...",
      "apnsId": "..."
    }
  ]
}
```

`failureReasons` is an aggregated map of APNs failure reasons (for example `BadDeviceToken`, `Unregistered`, or fallback values like `HTTP_503`).
`apnsSendConcurrency` reports the effective concurrency used by the server for this send batch.
`pushMetadataLookupConcurrency` reports the effective concurrency used for token ownership metadata lookups before send.
`invalidStoredTokensRemoved` reports malformed stored token strings cleaned from the user token set before send.
`skippedNonStringTokenCount` reports non-string token entries encountered while reading stored tokens (these are ignored and never sent to APNs).
Cleanup counters are derived from Redis command results when available, with a safe fallback to deduplicated attempted-token counts when command result formats are unavailable.

---

## APNs Environment Variables

### Required for token storage

- `REDIS_KV_REST_API_URL`
- `REDIS_KV_REST_API_TOKEN`

### Required for APNs test send

Required:

- `APNS_KEY_ID`
- `APNS_TEAM_ID`
- `APNS_BUNDLE_ID`
- `APNS_PRIVATE_KEY`

Optional:

- `APNS_USE_SANDBOX` (`true`/`1` for APNs sandbox)
- `APNS_ENDPOINT_OVERRIDE` (custom `https://` APNs gateway for staging/local testing; origin is used, path/query ignored)
- `APNS_CA_CERT` (PEM certificate for custom gateway trust chain)
- `APNS_SEND_CONCURRENCY` (optional integer `1..20`; defaults to `4`)
- `PUSH_METADATA_LOOKUP_CONCURRENCY` (optional integer `1..20`; defaults to `8`)

## Error Responses

Common statuses:

| Status | Cause |
|--------|-------|
| 400 | Invalid payload/token format, no registered tokens |
| 401 | Missing or invalid auth |
| 403 | Invalid origin or token not associated to user |
| 405 | Method not allowed |
| 500 | Redis/APNs configuration missing (`missingEnvVars` included) or unexpected internal server error |

`405 Method not allowed` responses include `Allow: POST, OPTIONS`.

Example Redis config error:

```json
{
  "error": "Redis is not configured.",
  "missingEnvVars": ["REDIS_KV_REST_API_URL", "REDIS_KV_REST_API_TOKEN"]
}
```

Example APNs config error:

```json
{
  "error": "APNs is not configured.",
  "missingEnvVars": ["APNS_KEY_ID", "APNS_TEAM_ID", "APNS_BUNDLE_ID", "APNS_PRIVATE_KEY"]
}
```

Example push-test cleanup 400 (no valid tokens remain):

```json
{
  "error": "No registered push tokens for this user",
  "invalidStoredTokensRemoved": 2,
  "skippedNonStringTokenCount": 1
}
```

Example push-test ownership 400 (no owned tokens remain):

```json
{
  "error": "No owned push tokens for this user",
  "staleOwnershipTokensRemoved": 3,
  "pushMetadataLookupConcurrency": 8,
  "invalidStoredTokensRemoved": 1,
  "skippedNonStringTokenCount": 0
}
```

Example push-test targeted ownership 403 (requested token removed during ownership cleanup):

```json
{
  "error": "Token is not registered for this user",
  "staleOwnershipTokensRemoved": 1,
  "pushMetadataLookupConcurrency": 8,
  "invalidStoredTokensRemoved": 0,
  "skippedNonStringTokenCount": 0
}
```

Example push-test targeted membership 403 (requested token not in user set):

```json
{
  "error": "Token is not registered for this user",
  "staleOwnershipTokensRemoved": 0,
  "pushMetadataLookupConcurrency": 0,
  "invalidStoredTokensRemoved": 0,
  "skippedNonStringTokenCount": 0
}
```

## Local Validation

Run all push-focused automated suites with:

```bash
bun run test:push
```

Run focused helper suites together when iterating on internals:

```bash
bun run test:push:helpers
```

Run only push guard suites (request/auth/config guards):

```bash
bun run test:push:guards
```

Run only config-guard suites (Redis/APNs guard helpers):

```bash
bun run test:push:config-guards
```

Run API-facing push suites together (payload/ownership/concurrency/error/auth-order/result/APNs):

```bash
bun run test:push:api
```

Or run focused suites individually:

```bash
bun run test:push-env
bun run test:push-auth-guard
bun run test:push-redis
bun run test:push-redis-guard
bun run test:push-apns-guard
bun run test:push-request-guard
bun run test:push-set-ops
bun run test:push-auth-order
```

Run the push suites through the aggregate runner (same suites, summary table format) with:

```bash
bun run test:push:aggregate
```

Run focused linting for push-related TypeScript modules with:

```bash
bun run lint:push
```

Run the full push validation bundle (lint + tests + build) with:

```bash
bun run check:push
```

Run the helper-focused validation bundle (lint + helper suites) with:

```bash
bun run check:push:helpers
```

Run the config-guard validation bundle (lint + Redis/APNs guard suites) with:

```bash
bun run check:push:config-guards
```

Run the guard-focused validation bundle (lint + guard suites) with:

```bash
bun run check:push:guards
```

Run the API-facing validation bundle (lint + API-facing suites) with:

```bash
bun run check:push:api
```

Run the aggregate-summary validation bundle (lint + aggregate suite summary + build) with:

```bash
bun run check:push:aggregate
```
