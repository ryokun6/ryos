# Push API

ryOS provides authenticated endpoints for managing device push tokens and sending APNs test notifications.

These endpoints are designed for the iOS Tauri wrapper integration and use Redis for token persistence.

## Authentication

All push endpoints require:

| Header | Description |
|--------|-------------|
| `Authorization` | Bearer token: `Bearer <token>` |
| `X-Username` | Username for the bearer token |

## Data Model

Redis keys used by the push API:

- `push:user:{username}:tokens` â€” Set of device tokens for a user
- `push:token:{token}` â€” Token metadata (`username`, `platform`, `updatedAt`)

Token metadata is stored with a 1-year TTL and ownership-safe cleanup behavior.

---

## Register Token

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/register` |

### Request Body

```json
{
  "token": "abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789",
  "platform": "ios"
}
```

### Fields

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `token` | string | Yes | 20-512 chars, alphanumeric plus `: _ - .` |
| `platform` | `"ios" \| "android"` | No | Defaults to `"ios"` |

### Behavior

- Associates the token with the authenticated user.
- If token metadata already belongs to a different user, the token is transferred and removed from the previous userâ€™s token set.

### Success Response (200)

```json
{
  "success": true,
  "token": "abcdef...",
  "platform": "ios"
}
```

---

## Unregister Token(s)

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/unregister` |

### Request Body

To remove one token:

```json
{
  "token": "abcdef..."
}
```

To remove all current user tokens:

```json
{}
```

### Behavior

- Single-token unregister validates token format.
- Metadata deletion only occurs when metadata ownership matches the authenticated user.
- Bulk unregister removes the user token set first, then deletes only metadata keys owned by the same user.

### Success Response (200)

```json
{
  "success": true,
  "removed": 1,
  "metadataRemoved": true
}
```

For bulk mode:

```json
{
  "success": true,
  "removed": 3,
  "metadataRemoved": 3
}
```

---

## Send Test Push

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/test` |

### Request Body

```json
{
  "title": "ryOS test notification",
  "body": "Push notifications are working ðŸŽ‰",
  "token": "optional-specific-token",
  "badge": 1,
  "sound": "default",
  "data": {
    "source": "manual-test"
  }
}
```

### Behavior

- Sends APNs alert notifications to:
  - all registered user tokens, or
  - one specific token if `token` is provided.
- Before sending, endpoint verifies token ownership via metadata and removes non-owned/stale set entries from the user token set.
- If APNs returns stale-token reasons (`BadDeviceToken`, `Unregistered`, `DeviceTokenNotForTopic`), stale tokens are removed from Redis.

### Success Response (200)

```json
{
  "successCount": 1,
  "failureCount": 0,
  "staleTokensRemoved": 0,
  "staleOwnershipTokensRemoved": 0,
  "results": [
    {
      "ok": true,
      "status": 200,
      "token": "abcdef...",
      "apnsId": "..."
    }
  ]
}
```

---

## APNs Environment Variables

Required:

- `APNS_KEY_ID`
- `APNS_TEAM_ID`
- `APNS_BUNDLE_ID`
- `APNS_PRIVATE_KEY`

Optional:

- `APNS_USE_SANDBOX` (`true`/`1` for APNs sandbox)
- `APNS_ENDPOINT_OVERRIDE` (custom `https://` APNs gateway for staging/local testing)
- `APNS_CA_CERT` (PEM certificate for custom gateway trust chain)

## Error Responses

Common statuses:

| Status | Cause |
|--------|-------|
| 400 | Invalid payload/token format, no registered tokens |
| 401 | Missing or invalid auth |
| 403 | Invalid origin or token not associated to user |
| 405 | Method not allowed |
| 500 | APNs configuration missing |
