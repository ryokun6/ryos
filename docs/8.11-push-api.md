# Push API

ryOS provides authenticated endpoints for managing device push tokens and sending APNs test notifications.

These endpoints are designed for the iOS Tauri wrapper integration and use Redis for token persistence.

## Authentication

All push endpoints require:

| Header | Description |
|--------|-------------|
| `Authorization` | Bearer token: `Bearer <token>` |
| `X-Username` | Username for the bearer token |

`Authorization` bearer scheme matching is case-insensitive (`Bearer`, `bearer`, etc.).

## Data Model

Redis keys used by the push API:

- `push:user:{username}:tokens` â€” Set of device tokens for a user
- `push:token:{token}` â€” Token metadata (`username`, `platform`, `updatedAt`)

Token metadata is stored with a 1-year TTL and ownership-safe cleanup behavior.

---

## Register Token

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/register` |

### Request Body

```json
{
  "token": "abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789",
  "platform": "ios"
}
```

Validation rules:

- `title` max length: 120 chars (default provided when empty/missing)
- `body` max length: 512 chars (default provided when empty/missing)
- `title`, `body`, `sound`, and `token` (if provided) must be strings
- `badge` must be integer `0..9999`
- `sound` max length: 64 chars
- `token` (if provided) must match push token format
- `data` must be a plain JSON object and serialized size <= 2048 bytes

### Fields

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `token` | string | Yes | 20-512 chars, alphanumeric plus `: _ - .` |
| `platform` | `"ios" \| "android"` | No | Defaults to `"ios"`; case-insensitive input accepted |

### Behavior

- Body must be a JSON object.
- Associates the token with the authenticated user.
- If token metadata already belongs to a different user, the token is transferred and removed from the previous userâ€™s token set.

### Success Response (200)

```json
{
  "success": true,
  "token": "abcdef...",
  "platform": "ios"
}
```

---

## Unregister Token(s)

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/unregister` |

### Request Body

To remove one token:

```json
{
  "token": "abcdef..."
}
```

To remove all current user tokens:

```json
{}
```

### Behavior

- Body must be a JSON object.
- Single-token unregister validates token format.
- Metadata deletion only occurs when metadata ownership matches the authenticated user.
- Bulk unregister removes the user token set first, then deletes only metadata keys owned by the same user.
- Bulk unregister also removes invalid token-string entries found in the user token set.

### Success Response (200)

```json
{
  "success": true,
  "removed": 1,
  "metadataRemoved": 1,
  "invalidStoredTokensRemoved": 0,
  "skippedNonStringTokenCount": 0
}
```

For bulk mode:

```json
{
  "success": true,
  "removed": 3,
  "metadataRemoved": 3,
  "invalidStoredTokensRemoved": 1,
  "skippedNonStringTokenCount": 0
}
```

---

## Send Test Push

### Endpoint

| Method | Path |
|--------|------|
| POST | `/api/push/test` |

### Request Body

```json
{
  "title": "ryOS test notification",
  "body": "Push notifications are working ðŸŽ‰",
  "token": "optional-specific-token",
  "badge": 1,
  "sound": "default",
  "data": {
    "source": "manual-test"
  }
}
```

### Behavior

- Sends APNs alert notifications to:
  - all registered user tokens, or
  - one specific token if `token` is provided.
- Multi-token sends are executed with bounded concurrency (currently 4 at a time) to avoid APNs burst overload.
- Invalid token-string entries discovered in the stored token set are cleaned up before sending.
- Before sending, endpoint verifies token ownership via metadata:
  - all tokens when broadcasting to all user tokens
  - just the requested token when `token` is explicitly provided
- Non-owned/stale token entries encountered during ownership checks are removed from the user token set.
- If APNs returns stale-token reasons (`BadDeviceToken`, `Unregistered`, `DeviceTokenNotForTopic`), stale tokens are removed from Redis.

### Success Response (200)

```json
{
  "successCount": 1,
  "failureCount": 0,
  "failureReasons": {},
  "apnsSendConcurrency": 4,
  "pushMetadataLookupConcurrency": 8,
  "invalidStoredTokensRemoved": 0,
  "skippedNonStringTokenCount": 0,
  "staleTokensRemoved": 0,
  "staleOwnershipTokensRemoved": 0,
  "results": [
    {
      "ok": true,
      "status": 200,
      "token": "abcdef...",
      "apnsId": "..."
    }
  ]
}
```

`failureReasons` is an aggregated map of APNs failure reasons (for example `BadDeviceToken`, `Unregistered`, or fallback values like `HTTP_503`).
`apnsSendConcurrency` reports the effective concurrency used by the server for this send batch.
`pushMetadataLookupConcurrency` reports the effective concurrency used for token ownership metadata lookups before send.
`invalidStoredTokensRemoved` reports malformed stored token strings cleaned from the user token set before send.
`skippedNonStringTokenCount` reports non-string token entries encountered while reading stored tokens (these are ignored and never sent to APNs).
Cleanup counters are derived from Redis command results when available, with a safe fallback to deduplicated attempted-token counts when command result formats are unavailable.

---

## APNs Environment Variables

### Required for token storage

- `REDIS_KV_REST_API_URL`
- `REDIS_KV_REST_API_TOKEN`

### Required for APNs test send

Required:

- `APNS_KEY_ID`
- `APNS_TEAM_ID`
- `APNS_BUNDLE_ID`
- `APNS_PRIVATE_KEY`

Optional:

- `APNS_USE_SANDBOX` (`true`/`1` for APNs sandbox)
- `APNS_ENDPOINT_OVERRIDE` (custom `https://` APNs gateway for staging/local testing; origin is used, path/query ignored)
- `APNS_CA_CERT` (PEM certificate for custom gateway trust chain)
- `APNS_SEND_CONCURRENCY` (optional integer `1..20`; defaults to `4`)
- `PUSH_METADATA_LOOKUP_CONCURRENCY` (optional integer `1..20`; defaults to `8`)

## Error Responses

Common statuses:

| Status | Cause |
|--------|-------|
| 400 | Invalid payload/token format, no registered tokens |
| 401 | Missing or invalid auth |
| 403 | Invalid origin or token not associated to user |
| 405 | Method not allowed |
| 500 | Redis/APNs configuration missing (`missingEnvVars` included) or unexpected internal server error |

Example Redis config error:

```json
{
  "error": "Redis is not configured.",
  "missingEnvVars": ["REDIS_KV_REST_API_URL", "REDIS_KV_REST_API_TOKEN"]
}
```

Example APNs config error:

```json
{
  "error": "APNs is not configured.",
  "missingEnvVars": ["APNS_KEY_ID", "APNS_TEAM_ID", "APNS_BUNDLE_ID", "APNS_PRIVATE_KEY"]
}
```

## Local Validation

Run all push-focused automated suites with:

```bash
bun run test:push
```

Run focused helper suites when iterating on internals:

```bash
bun run test:push-env
bun run test:push-redis
bun run test:push-set-ops
```

Run the push suites through the aggregate runner (same suites, summary table format) with:

```bash
bun run test:push:aggregate
```

Run focused linting for push-related TypeScript modules with:

```bash
bun run lint:push
```

Run the full push validation bundle (lint + tests + build) with:

```bash
bun run check:push
```
