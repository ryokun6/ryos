# Rooms API

Endpoints for creating, listing, and managing chat rooms.

## Overview

Chat rooms are either **public** (visible to all users) or **private** (visible only to members). Authenticated users can create private rooms; public rooms are created by the admin user (`ryo`).

## Endpoint Summary

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/rooms` | List rooms (public + private membership) | No |
| POST | `/api/rooms` | Create room | Yes |
| GET | `/api/rooms/{id}` | Get room by ID | No |
| DELETE | `/api/rooms/{id}` | Delete room | Yes |
| POST | `/api/rooms/{id}/join` | Join room | No |
| POST | `/api/rooms/{id}/leave` | Leave room | No |
| GET | `/api/rooms/{id}/users` | List active users | No |

## Endpoints

### List Rooms

Get all public rooms and private rooms where the user is a member.

```bash
GET /api/rooms?username=alice
```

**Query Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `username` | string | No | Filter to include user's private rooms |

**Response (200):**

```json
{
  "rooms": [
    {
      "id": "general",
      "name": "General Chat",
      "type": "public",
      "createdAt": 1704067200000,
      "userCount": 15
    },
    {
      "id": "abc123",
      "name": "Private Room",
      "type": "private",
      "members": ["alice", "bob"],
      "createdAt": 1704153600000,
      "userCount": 2
    }
  ]
}
```

### Create Room

Create a new chat room. Requires authentication.

```bash
POST /api/rooms
Authorization: Bearer {token}
X-Username: alice
Content-Type: application/json

{
  "type": "private",
  "members": ["alice", "bob"]
}
```

**Request Body:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | No | `"public"` or `"private"` (default: `"public"`) |
| `members` | string[] | For private | List of usernames (required for private rooms) |
| `name` | string | For public | Room display name (required for public rooms) |

**Notes:**
- Public rooms can only be created by the admin user (`ryo`).
- Private rooms automatically include the creator in the member list.
- Public room names are normalized to lowercase hyphenated slugs (e.g., `"General Chat"` â†’ `"general-chat"`).
- Private room names are generated from sorted members (e.g., `"@alice, @bob"`).

**Response (201):**

```json
{
  "room": {
    "id": "abc123def456",
    "name": "@alice, @bob",
    "type": "private",
    "members": ["alice", "bob"],
    "createdAt": 1704067200000,
    "userCount": 2
  }
}
```

### Get Room

Get details for a specific room.

```bash
GET /api/rooms/{id}
```

**Response (200):**

```json
{
  "room": {
    "id": "general",
    "name": "General Chat",
    "type": "public",
    "createdAt": 1704067200000,
      "userCount": 15
  }
}
```

### Delete Room

Delete a room. Public rooms require admin access. Private rooms can be deleted by any member; if the remaining member count drops to 1 or fewer, the room is deleted.

```bash
DELETE /api/rooms/{id}
Authorization: Bearer {token}
X-Username: alice
```

**Response (200):**

```json
{
  "success": true
}
```

### Join Room

Join a room to participate in chat (presence tracking). The user must already exist in the chat system.

```bash
POST /api/rooms/{id}/join
Content-Type: application/json

{
  "username": "alice"
}
```

**Response (200):**

```json
{
  "success": true
}
```

**Notes:**
- Returns `404` if the room does not exist.
- Returns `404` if the user does not exist (users are created via auth or first chat message).

### Leave Room

Leave a room (presence tracking).

```bash
POST /api/rooms/{id}/leave
Content-Type: application/json

{
  "username": "alice"
}
```

**Response (200):**

```json
{
  "success": true
}
```

**Notes:**
- Returns `404` if the room does not exist.
- Returns `404` if the user does not exist.

### List Active Users

Get list of users currently active in a room.

```bash
GET /api/rooms/{id}/users
```

**Response (200):**

```json
{
  "users": ["alice", "bob"]
}
```

## Room Types

### Public Rooms

- Visible to all users in room listings
- Anyone can join without invitation
- Created by admin (`ryo`) only

### Private Rooms

- Only visible to members (when `username` query param is provided)
- Created with a specific member list
- Ideal for direct messages or group chats

## Error Responses

| Status | Error | Description |
|--------|-------|-------------|
| 400 | `Invalid request` | Missing or invalid parameters |
| 401 | `Authentication required` | Token missing or invalid |
| 403 | `Forbidden` | Not authorized to perform action |
| 404 | `Room not found` | Room ID doesn't exist |
| 404 | `User not found` | Username doesn't exist |
| 429 | `Rate limit exceeded` | Too many requests |

## Related

- [Auth API](/docs/auth-api) - Authentication endpoints
- [Messages API](/docs/messages-api) - Message endpoints
- [Presence API](/docs/presence-api) - Presence tracking
