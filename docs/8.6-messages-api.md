# Messages API

Endpoints for sending, retrieving, and managing messages in chat rooms.

## Overview

Messages are the core communication unit in chat rooms. Authenticated users can send messages, and anyone can retrieve message history.

## Endpoint Summary

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/rooms/{id}/messages` | List messages | No |
| POST | `/api/rooms/{id}/messages` | Send message | Yes |
| DELETE | `/api/rooms/{id}/messages/{messageId}` | Delete message | Yes (admin) |
| GET | `/api/messages/bulk?roomIds=...` | Bulk fetch messages | No |

## Endpoints

### List Messages

Get message history for a room.

```bash
GET /api/rooms/{id}/messages?limit=20
```

**Query Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `limit` | number | No | Max messages to return (default: 20, max: 500) |

**Response (200):**

```json
{
  "messages": [
    {
      "id": "msg123",
      "roomId": "general",
      "username": "alice",
      "content": "Hello everyone!",
      "timestamp": 1704067200000
    },
    {
      "id": "msg124",
      "roomId": "general",
      "username": "bob",
      "content": "Hi Alice!",
      "timestamp": 1704067260000
    }
  ]
}
```

### Send Message

Send a message to a room. Requires authentication.

```bash
POST /api/rooms/{id}/messages
Authorization: Bearer {token}
X-Username: alice
Content-Type: application/json

{
  "content": "Hello world!"
}
```

**Request Body:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `content` | string | Yes | Message content (max 1000 chars) |

**Response (201):**

```json
{
  "message": {
    "id": "msg125",
    "roomId": "general",
    "username": "alice",
    "content": "Hello world!",
    "timestamp": 1704067320000
  }
}
```

### Delete Message (Admin)

Delete a specific message. Admin only.

```bash
DELETE /api/rooms/{roomId}/messages/{messageId}
Authorization: Bearer {token}
X-Username: ryo
```

**Response (200):**

```json
{
  "success": true
}
```

### Bulk Fetch Messages

Fetch messages from multiple rooms in a single request.

```bash
GET /api/messages/bulk?roomIds=general,random,private123
```

**Query Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `roomIds` | string | Yes | Comma-separated room IDs |

**Response (200):**

```json
{
  "messagesMap": {
    "general": [
      {
        "id": "msg123",
        "username": "alice",
        "content": "Hello!",
        "timestamp": 1704067200000
      }
    ],
    "random": []
  },
  "validRoomIds": ["general", "random"],
  "invalidRoomIds": ["private123"]
}
```

## Rate Limits

Messages in public rooms have burst protection:

| Limit Type | Window | Max Messages |
|------------|--------|--------------|
| Short burst | 10 seconds | 3 messages |
| Long burst | 1 minute | 20 messages |
| Min interval | - | 2 seconds between messages |

Private rooms bypass burst rate limiting.

## Message Format

Messages contain the following fields:

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Unique message identifier |
| `roomId` | string | Room the message belongs to |
| `username` | string | Author's username |
| `content` | string | Message text content |
| `timestamp` | number | Unix timestamp (milliseconds) |

## Error Responses

| Status | Error | Description |
|--------|-------|-------------|
| 400 | `Invalid request` | Missing or invalid parameters |
| 400 | `Content too long` | Message exceeds 1000 characters |
| 401 | `Authentication required` | Token missing or invalid |
| 403 | `Forbidden` | Not authorized to delete (non-admin) |
| 404 | `Room not found` | Room ID doesn't exist |
| 404 | `Message not found` | Message ID doesn't exist |
| 429 | `Rate limit exceeded` | Too many messages too quickly |

## Related

- [Rooms API](/docs/rooms-api) - Room endpoints
- [Presence API](/docs/presence-api) - Presence tracking
- [Auth API](/docs/auth-api) - Authentication endpoints
