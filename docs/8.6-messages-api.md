# Messages API

Endpoints for sending, retrieving, and managing messages in chat rooms.

## Overview

Messages are the core communication unit in chat rooms. Authenticated users can send messages, and anyone can retrieve message history.

## Endpoint Summary

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/rooms/{id}/messages` | List messages | No |
| POST | `/api/rooms/{id}/messages` | Send message | Yes |
| DELETE | `/api/rooms/{id}/messages/{messageId}` | Delete message | Yes (admin) |
| GET | `/api/messages/bulk?roomIds=...` | Bulk fetch messages | No |

## Endpoints

### List Messages

Get message history for a room.

```bash
GET /api/rooms/{id}/messages?limit=50&before=1704153600000
```

**Query Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `limit` | number | No | Max messages to return (default: 50, max: 100) |
| `before` | number | No | Fetch messages before this timestamp |
| `after` | number | No | Fetch messages after this timestamp |

**Response (200):**

```json
{
  "messages": [
    {
      "id": "msg123",
      "roomId": "general",
      "username": "alice",
      "content": "Hello everyone!",
      "timestamp": 1704067200000
    },
    {
      "id": "msg124",
      "roomId": "general",
      "username": "bob",
      "content": "Hi Alice!",
      "timestamp": 1704067260000
    }
  ],
  "hasMore": true
}
```

### Send Message

Send a message to a room. Requires authentication.

```bash
POST /api/rooms/{id}/messages
Authorization: Bearer {token}
X-Username: alice
Content-Type: application/json

{
  "content": "Hello world!"
}
```

**Request Body:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `content` | string | Yes | Message content (max 2000 chars) |

**Response (200):**

```json
{
  "message": {
    "id": "msg125",
    "roomId": "general",
    "username": "alice",
    "content": "Hello world!",
    "timestamp": 1704067320000
  }
}
```

### Delete Message (Admin)

Delete a specific message. Admin only.

```bash
DELETE /api/rooms/{roomId}/messages/{messageId}
Authorization: Bearer {token}
X-Username: ryo
```

**Response (200):**

```json
{
  "success": true
}
```

### Bulk Fetch Messages

Fetch messages from multiple rooms in a single request.

```bash
GET /api/messages/bulk?roomIds=general,random,private123
```

**Query Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `roomIds` | string | Yes | Comma-separated room IDs |
| `limit` | number | No | Max messages per room (default: 20) |

**Response (200):**

```json
{
  "rooms": {
    "general": {
      "messages": [
        {
          "id": "msg123",
          "username": "alice",
          "content": "Hello!",
          "timestamp": 1704067200000
        }
      ],
      "hasMore": true
    },
    "random": {
      "messages": [],
      "hasMore": false
    }
  }
}
```

## Rate Limits

Messages in public rooms have burst protection:

| Limit Type | Window | Max Messages |
|------------|--------|--------------|
| Short burst | 10 seconds | 5 messages |
| Long burst | 1 minute | 15 messages |
| Min interval | - | 500ms between messages |

Private rooms have relaxed rate limits.

## Message Format

Messages contain the following fields:

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Unique message identifier |
| `roomId` | string | Room the message belongs to |
| `username` | string | Author's username |
| `content` | string | Message text content |
| `timestamp` | number | Unix timestamp (milliseconds) |

## Error Responses

| Status | Error | Description |
|--------|-------|-------------|
| 400 | `Invalid request` | Missing or invalid parameters |
| 400 | `Content too long` | Message exceeds 2000 characters |
| 401 | `Authentication required` | Token missing or invalid |
| 403 | `Forbidden` | Not authorized to delete (non-admin) |
| 404 | `Room not found` | Room ID doesn't exist |
| 404 | `Message not found` | Message ID doesn't exist |
| 429 | `Rate limit exceeded` | Too many messages too quickly |

## Related

- [Rooms API](/docs/rooms-api) - Room endpoints
- [Presence API](/docs/presence-api) - Presence tracking
- [Auth API](/docs/auth-api) - Authentication endpoints
